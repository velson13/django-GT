{% extends "base.html" %}
{% block content %}

<h4 style="color: #8f8f8f;">SEF Webhook</h4>

<div class="mb-3">
    <button id="delete-selected" class="btn btn-danger btn-sm">Delete selected</button>
    <button id="delete-all" class="btn btn-warning btn-sm">Delete ALL</button>
    <button id="toggle-refresh" class="btn btn-secondary btn-sm">Pause Auto-Refresh</button>
</div>

<form style="display:none;">{% csrf_token %}</form>

<h5>Ulazne</h5>
<table class="table table-bordered" id="ulazne-table">
    <thead>
        <tr>
            <th><input type="checkbox" id="chk-ulazne-all"></th>
            <th>Primljeno</th>
            <th>Payload</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<h5>Izlazne</h5>
<table class="table table-bordered" id="izlazne-table">
    <thead>
        <tr>
            <th><input type="checkbox" id="chk-izlazne-all"></th>
            <th>Primljeno</th>
            <th>Payload</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split("; ");
        for (let cookie of cookies) {
            const [key, val] = cookie.split("=");
            if (key === name) {
                return decodeURIComponent(val);
            }
        }
    }
    return null;
}

const csrftoken = getCookie("csrftoken");

function loadTables() {
    fetch(window.location.href + "?ajax=1")
    .then(r => r.json())
    .then(data => {
        // ULAZNE
        var uBody = document.querySelector("#ulazne-table tbody");
        uBody.innerHTML = "";
        data.ulazne.forEach(ev => {
            uBody.innerHTML += `
                <tr>
                    <td><input type="checkbox" class="chk-row" value="${ev.id}"></td>
                    <td>${ev.received_at}</td>
                    <td><pre>${JSON.stringify(ev.payload, null, 2)}</pre></td>
                </tr>`;
        });

        // IZLAZNE
        var iBody = document.querySelector("#izlazne-table tbody");
        iBody.innerHTML = "";
        data.izlazne.forEach(ev => {
            iBody.innerHTML += `
                <tr>
                    <td><input type="checkbox" class="chk-row" value="${ev.id}"></td>
                    <td>${ev.received_at}</td>
                    <td><pre>${JSON.stringify(ev.payload, null, 2)}</pre></td>
                </tr>`;
        });
    });
}

// Auto refresh every 5 seconds or pause
let autoRefresh = true;
let refreshInterval = setInterval(refreshTables, 5000);

function refreshTables() {
    if (!autoRefresh) return;
    loadTables();
}

// Toggle button
document.getElementById("toggle-refresh").onclick = function() {
    autoRefresh = !autoRefresh;
    this.textContent = autoRefresh ? "Pause Auto-Refresh" : "Resume Auto-Refresh";
};

// Initial load
loadTables();



// DELETE SELECTED
document.getElementById("delete-selected").onclick = function() {
    var ids = [...document.querySelectorAll(".chk-row:checked")].map(i => i.value);
    if (ids.length === 0) {
        alert("Select at least one entry");
        return;
    }

    var form = new FormData();
    ids.forEach(id => form.append("ids[]", id));

    fetch("{% url 'webhook_delete' %}", {
        method: "POST",
        body: form,
        headers: { "X-CSRFToken": csrftoken }
    })
    .then(_ => loadTables());
    //showToast("Odabrani webhook zapisi su izbrisani.", "success");
};

// DELETE ALL
document.getElementById("delete-all").onclick = function() {
    var form = new FormData();
    form.append("delete_all", "1");

    if (!confirm("Izbrisati SVE webhook zapise?")) return;

    fetch("{% url 'webhook_delete' %}", {
        method: "POST",
        body: form,
        headers: { "X-CSRFToken": csrftoken }
    }).then(_ => loadTables());
    //showToast("Svi webhook zapisi su izbrisani.", "success");
};

// SELECT ALL CHECKBOXES
document.getElementById("chk-ulazne-all").onchange = function() {
    document.querySelectorAll("#ulazne-table .chk-row").forEach(c => c.checked = this.checked);
};
document.getElementById("chk-izlazne-all").onchange = function() {
    document.querySelectorAll("#izlazne-table .chk-row").forEach(c => c.checked = this.checked);
};
</script>

{% endblock %}
